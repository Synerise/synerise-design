const { transform } = require('@svgr/core');
const hash = require('string-hash');
const glob = require('glob');
const fs = require('fs');
const path = require('path');
const tpl = require('./template.js');

const LIB_DIR = 'src/defaultAvatars';
const INDEX_FILE = `${LIB_DIR}/index.ts`;

const titlecase = (input) => input[0].toLocaleUpperCase() + input.slice(1);

const pascalCase = (value) => {
  if (value === null || value === void 0) return '';
  if (typeof value.toString !== 'function') return '';

  let input = value.toString().trim();
  if (input === '') return '';
  if (input.length === 1) return input.toLocaleUpperCase();

  let match = input.match(/[a-zA-Z0-9]+/g);
  if (match) {
    return match.map((m) => titlecase(m)).join('');
  }

  return input;
};

const pascalCaseFilename = (filePath) => {
  const filename = path.basename(filePath).replace('.svg', '');
  return pascalCase(filename);
};

const kebabCaseFilename = (filePath) => {
  const filename = path.basename(filePath).replace('.svg', '');
  return filename;
};

if (!fs.existsSync(LIB_DIR)) {
  fs.mkdirSync(LIB_DIR, { recursive: true });
}

const files = glob.sync('src/svg/defaultAvatars/*.svg');
(function (files) {
  if (files.length === 0) {
    console.log(
      'No SVG files found in src/svg/defaultAvatars/. Skipping SVGR build.',
    );
    // Write empty index so TypeScript doesn't break
    fs.writeFileSync(
      INDEX_FILE,
      '// No default avatar SVGs found. Place SVG files in src/svg/defaultAvatars/ and rebuild.\nexport {};\n',
    );
    return;
  }

  // Clear index file
  fs.writeFileSync(
    INDEX_FILE,
    '// Auto-generated by build:svgr. Do not edit manually.\n',
  );

  const componentNames = [];

  Promise.all(
    files.sort().map((file) => {
      const componentName = pascalCaseFilename(file);
      const componentClassName = kebabCaseFilename(file);

      return new Promise((resolve, reject) => {
        fs.readFile(file, 'UTF-8', (err, content) => {
          if (err) {
            reject(err);
            return;
          }
          transform(
            content,
            {
              template: tpl,
              typescript: true,
              plugins: ['@svgr/plugin-svgo', '@svgr/plugin-jsx'],
              svgoConfig: {
                plugins: [
                  {
                    name: 'prefixIds',
                    params: {
                      delim: '',
                      prefix: () => `svg-${hash(file)}`,
                    },
                  },
                  {
                    name: 'cleanupIds',
                    params: {
                      remove: true,
                      minify: true,
                      preservePrefixes: [`svg-${hash(file)}`],
                    },
                  },
                  {
                    name: 'addClassesToSVGElement',
                    params: {
                      className: `${componentClassName} ds-default-avatar`,
                    },
                  },
                  'removeDimensions',
                  'removeTitle',
                  'convertStyleToAttrs',
                  {
                    name: 'removeAttrs',
                    params: {
                      attrs: 'enable-background',
                      elemSeparator: ':',
                      preserveCurrentColor: false,
                    },
                  },
                  {
                    name: 'inlineStyles',
                    params: {
                      onlyMatchedOnce: false,
                      removeMatchedSelectors: true,
                    },
                  },
                ],
              },
            },
            { componentName },
          )
            .then((jsCode) => {
              fs.writeFileSync(`${LIB_DIR}/${componentName}.tsx`, jsCode);
              fs.appendFileSync(
                INDEX_FILE,
                `export { default as ${componentName} } from './${componentName}';\n`,
              );
              componentNames.push(componentName);
              resolve(componentName);
            })
            .catch(reject);
        });
      });
    }),
  )
    .then((names) => {
      // Append the ordered array and count
      const sorted = files.sort().map((f) => pascalCaseFilename(f));
      const arrayImports = sorted.map((name) => `  ${name},`).join('\n');
      const arrayContent = `\nimport type { ComponentType } from 'react';\n${sorted.map((name) => `import ${name} from './${name}';`).join('\n')}\n\nexport const DEFAULT_AVATARS: ComponentType<React.SVGProps<SVGSVGElement>>[] = [\n${arrayImports}\n];\n\nexport const TOTAL_DEFAULT_AVATARS = ${sorted.length};\n`;
      fs.appendFileSync(INDEX_FILE, arrayContent);
      console.log(`Generated ${names.length} default avatar components`);
    })
    .catch((err) => {
      console.error('Error generating avatar components:', err);
      process.exit(1);
    });
})(files);
